#include <stdio.h>
#include <string.h>

#define MAX 100
#define FILE_NAME "students.txt"

struct info {
    int id;
    char name[50];
    char department[50];
    float cgpa;
};

struct info student[MAX];
int studentCount = 0;

/* Function Prototypes */
void loadFromFile();
void saveToFile();
void addStudent();
void deleteStudent();
void updateStudent();
void searchStudent();
void displayStudent();
void menu();

int main() {
    loadFromFile();   // Load ONCE
    menu();
    return 0;
}

/* Load data from file */
void loadFromFile() {
    FILE *fp = fopen(FILE_NAME, "r");
    if (!fp) return;

    studentCount = 0;
    while (fscanf(fp, "%d,%49[^,],%49[^,],%f\n",
                  &student[studentCount].id,
                  student[studentCount].name,
                  student[studentCount].department,
                  &student[studentCount].cgpa) == 4) {
        studentCount++;
    }
    fclose(fp);
}

/* Save data to file */
void saveToFile() {
    FILE *fp = fopen(FILE_NAME, "w");
    if (!fp) {
        printf("Error saving file!\n");
        return;
    }

    for (int i = 0; i < studentCount; i++) {
        fprintf(fp, "%d,%s,%s,%.2f\n",
                student[i].id,
                student[i].name,
                student[i].department,
                student[i].cgpa);
    }
    fclose(fp);
}

/* Add Student */
void addStudent() {
    if (studentCount >= MAX) {
        printf("Student limit reached!\n");
        return;
    }

    int id;
    printf("Enter Student ID: ");
    scanf("%d", &id);

    for (int i = 0; i < studentCount; i++) {
        if (student[i].id == id) {
            printf("Student with this ID already exists!\n");
            return;
        }
    }

    student[studentCount].id = id;

    printf("Enter Name: ");
    scanf(" %[^\n]", student[studentCount].name);

    printf("Enter Department: ");
    scanf(" %[^\n]", student[studentCount].department);

    do {
        printf("Enter CGPA (0.0 - 4.0): ");
        scanf("%f", &student[studentCount].cgpa);
    } while (student[studentCount].cgpa < 0 || student[studentCount].cgpa > 4);

    studentCount++;
    saveToFile();
    printf("Student added successfully!\n");
}

/* Delete Student */
void deleteStudent() {
    int id, index = -1;
    printf("Enter Student ID to delete: ");
    scanf("%d", &id);

    for (int i = 0; i < studentCount; i++) {
        if (student[i].id == id) {
            index = i;
            break;
        }
    }

    if (index == -1) {
        printf("Student not found!\n");
        return;
    }

    for (int i = index; i < studentCount - 1; i++) {
        student[i] = student[i + 1];
    }

    studentCount--;
    saveToFile();
    printf("Student deleted successfully!\n");
}

/* Update Student */
void updateStudent() {
    int id, found = 0;
    printf("Enter Student ID to update: ");
    scanf("%d", &id);

    for (int i = 0; i < studentCount; i++) {
        if (student[i].id == id) {
            found = 1;

            printf("Enter New Name: ");
            scanf(" %[^\n]", student[i].name);

            printf("Enter New Department: ");
            scanf(" %[^\n]", student[i].department);

            do {
                printf("Enter New CGPA (0.0 - 4.0): ");
                scanf("%f", &student[i].cgpa);
            } while (student[i].cgpa < 0 || student[i].cgpa > 4);

            saveToFile();
            printf("Student updated successfully!\n");
            break;
        }
    }

    if (!found) {
        printf("Student not found!\n");
    }
}

/* Search Student */
void searchStudent() {
    int id;
    printf("Enter Student ID to search: ");
    scanf("%d", &id);

    for (int i = 0; i < studentCount; i++) {
        if (student[i].id == id) {
            printf("\nStudent Found:\n");
            printf("ID: %d\nName: %s\nDepartment: %s\nCGPA: %.2f\n",
                   student[i].id,
                   student[i].name,
                   student[i].department,
                   student[i].cgpa);
            return;
        }
    }
    printf("Student not found!\n");
}

/* Display All Students */
void displayStudent() {
    if (studentCount == 0) {
        printf("No students available!\n");
        return;
    }

    for (int i = 0; i < studentCount; i++) {
        printf("\nStudent %d\n", i + 1);
        printf("ID: %d\nName: %s\nDepartment: %s\nCGPA: %.2f\n",
               student[i].id,
               student[i].name,
               student[i].department,
               student[i].cgpa);
    }
}

/* Menu */
void menu() {
    int choice;
    while (1) {
        printf("\n--- STUDENT MANAGEMENT SYSTEM ---\n");
        printf("1. Add Student\n");
        printf("2. Delete Student\n");
        printf("3. Update Student\n");
        printf("4. Search Student\n");
        printf("5. Display Students\n");
        printf("6. Exit\n");
        printf("Enter your choice: ");
        scanf("%d", &choice);

        switch (choice) {
            case 1: addStudent(); break;
            case 2: deleteStudent(); break;
            case 3: updateStudent(); break;
            case 4: searchStudent(); break;
            case 5: displayStudent(); break;
            case 6: printf("Thank you! Exiting...\n"); return;
            default: printf("Invalid choice!\n");
        }
    }
}
